class EE{constructor(){this.events={}}on(t,e){this.events[t]=this.events[t]||[],this.events[t].push({cb:e,remove:!1})}once(t,e){this.events[t]=this.events[t]||[],this.events[t].push({cb:e,remove:!0})}emit(t,...e){this.events[t]instanceof Array&&this.events[t].forEach((s,i)=>{s.cb(...e),s.remove&&this.events[t].splice(i,1)})}}class Drawer{constructor(t={}){this.fillStyle=t.fillStyle||"black",this.offsetX="number"==typeof t.offsetX&&t.offsetX>0?t.offsetX:4,this.offsetY="number"==typeof t.offsetY&&t.offsetY>0?t.offsetY:4,this.blockSide="number"==typeof t.blockSide&&t.blockSide>0?t.blockSide:24,this.elemSide=this.blockSide-this.offsetX-this.offsetY}cc(t={}){const e=document.createElement("canvas");e.width=this.blockSide,e.height=this.blockSide,e.style.cursor="pointer",e.style["margin-right"]="2px",t.id&&e.setAttribute("id",t.id);const s=e.getContext("2d");return s.fillStyle=this.fillStyle,{canvas:e,ctx:s}}mute(){const{canvas:t,ctx:e}=this.cc({id:"mute"});return e.beginPath(),e.moveTo(4,8),e.lineTo(8,8),e.lineTo(16,4),e.lineTo(16,20),e.lineTo(8,16),e.lineTo(4,16),e.closePath(),e.fill(),t}muted(){const{canvas:t,ctx:e}=this.cc({id:"muted"});return e.beginPath(),e.moveTo(4,8),e.lineTo(8,8),e.lineTo(16,4),e.lineTo(16,20),e.lineTo(8,16),e.lineTo(4,16),e.moveTo(4,5),e.lineTo(19,20),e.lineTo(20,19),e.lineTo(5,4),e.closePath(),e.fill(),t}pause(){const{canvas:t,ctx:e}=this.cc({id:"pause"}),s=this.elemSide/2-this.offsetX/2;return e.fillRect(this.offsetX,this.offsetY,s,this.elemSide),e.fillRect(2*this.offsetX+s,this.offsetY,s,this.elemSide),t}play(){const{canvas:t,ctx:e}=this.cc({id:"play"});return e.beginPath(),e.moveTo(4,4),e.lineTo(20,12),e.lineTo(4,20),e.closePath(),e.fill(),t}skip(){const{canvas:t,ctx:e}=this.cc({id:"skip"});return e.beginPath(),e.moveTo(4,4),e.lineTo(18,12),e.lineTo(4,20),e.lineTo(4,4),e.moveTo(18,12),e.lineTo(18,20),e.lineTo(20,20),e.lineTo(20,4),e.lineTo(18,4),e.closePath(),e.fill(),t}stop(){const{canvas:t,ctx:e}=this.cc({id:"stop"});return e.fillRect(this.offsetX,this.offsetY,this.elemSide,this.elemSide),t}}class VastPlayer extends EE{constructor(t={}){if(super(),this.d=new Drawer({fillStyle:"white"}),this.w="number"==typeof t.w&&t.w>0?t.w:480,this.h="number"==typeof t.h&&t.h>0?t.h:320,this.skipable="boolean"!=typeof t.skipable||t.skipable,this.skipAfter="number"==typeof t.skipAfter?t.skipAfter:5,this.ap="boolean"!=typeof t.ap||t.ap,this.id="string"==typeof t.id&&t.id.length?t.id:"vast-player",this.ctrlBtns={},this.cache={},this.defaults={skip:"boolean"!=typeof t.skipable||t.skipable,volume:"number"==typeof t.volume?t.volume:0},this.target=document.getElementById("player"),this.target.style.display="block",!this.target)throw new Error("Element with id %s was not found");this.on("error",t=>{console.error("error",t)})}init(t){this.vTag=document.createElement("video"),this.vTag.setAttribute("id",this.id),this.vTag.setAttribute("src",t),this.vTag.setAttribute("preload","auto"),this.vTag.setAttribute("crossorigin","true"),this.vTag.setAttribute("width",this.w),this.vTag.setAttribute("height",this.h),this.vTag.style.background="black",this.target.appendChild(this.vTag),this.registerPlayerEvents(),this.setDefaults()}registerPlayerEvents(){this.vTag.addEventListener("canplay",()=>{try{this.ap&&this.vTag.play()}catch(t){console.error(t)}this.cache.hasHours="number"==typeof this.vTag.duration&&this.vTag.duration>3600,this.ctrlBtns.progress.duration.innerText="/ "+formatTime(this.vTag.duration,this.cache.hasHours),this.cache.hasHours&&(this.ctrlBtns.progress.current.innerText=formatTime(0,this.cache.hasHours))}),this.vTag.addEventListener("loadeddata",()=>{this.emit("ready"),this.emit("creativeView")}),this.enableControls();let t=!1;this.vTag.addEventListener("timeupdate",()=>{this.ctrlBtns.progress.current.innerText=formatTime(this.vTag.currentTime,this.cache.hasHours);const e=this.vTag.currentTime/this.vTag.duration;switch(this.progress.__update__(e),!t&&this.vTag.currentTime>this.skipAfter&&(document.getElementById("skip").style.display="",t=!0),!0){case e>.25&&!this.cache.firstQuartile:this.cache.firstQuartile=!0,this.emit("firstQuartile");break;case e>.5&&!this.cache.midpoint:this.cache.midpoint=!0,this.emit("midpoint");break;case e>.75&&!this.cache.thirdQuartile:this.cache.thirdQuartile=!0,this.emit("thirdQuartile")}}),this.vTag.addEventListener("play",()=>{this.emit("play",this.vTag.currentTime),this.emit("start",this.vTag.currentTime),this.emit("impression",this.vTag.currentTime)}),this.vTag.addEventListener("pause",()=>{this.emit("pause",this.vTag.currentTime)}),this.vTag.addEventListener("ended",()=>{this.emit("complete")})}setDefaults(){this.cache.volume=1,this.vTag.volume=this.defaults.volume,this.vTag.muted=0===this.defaults.volume}progressLine(t,e,s){const i=document.createElement("div");return i.setAttribute("id",this.id+t),i.style.width=this.w+"px",i.style.height="2px",i.style.background=e,i.style.top=s,i.style.position="relative",i}progressBar(){return this.pgb=this.progressLine("pgb","white","-59px"),this.pgb.style.opacity="0.7",this.progress=this.progressLine("progress","red",""),this.progress.style.width="0px",this.progress.__update__=function(t){this.progress.style.width=Math.round(this.w*t)+"px"}.bind(this),this.pgb.appendChild(this.progress),this.pgb}enableControls(){const t=this.conTag=document.createElement("div");let e,s,i,r;t.setAttribute("id",this.id+"-controls"),t.setAttribute("class",this.id+"-controls"),t.style.top="-29px",t.style.display="block",t.style.position="relative",t.style.color="white",t.style.width=this.w+"px",t.style.height="24px",t.style["text-align"]="center",0===this.defaults.volume?(e=this.d.muted(),s=this.d.mute()):(e=this.d.mute(),s=this.d.muted()),this.ap?(i=this.d.pause(),r=this.d.play()):(i=this.d.play(),r=this.d.pause());const n=[{id:"play",click:"playPause",value:i,toggle:r},{id:"mute",click:"mute",value:e,toggle:s},{id:"skip",click:"close",value:this.d.skip(),toggle:"",style:"display:none;"},{id:"progress",click:null,value:[{id:"current",click:null,value:"00:00",style:"position:absolute;top:3px;left:10px;"},{id:"duration",click:null,value:"/ 00:00",style:"position:absolute;top:3px;left:50px;"}]}],a=(t,e)=>{t.forEach(t=>{switch(!0){case t.value instanceof Array:return e[t.id]=e[t.id]||{},void a(t.value,e[t.id]);case"string"==typeof t.value:{const s=document.createElement("a");return s.setAttribute("id",t.id),s.innerText=t.value,t.style&&s.setAttribute("style",t.style),this.conTag.appendChild(s),e[t.id]=s,void(null!==t.click&&s.addEventListener("click",()=>{this[t.click]()}))}case t.value instanceof HTMLCanvasElement:{this.conTag.appendChild(t.value),e[t.value.id]=t.value;const s=t.toggle instanceof HTMLCanvasElement;t.style&&t.value.setAttribute("style",t.style),null!==t.click&&t.value.addEventListener("click",()=>{this[t.click](),s&&(changeVisibility(t.value),changeVisibility(t.toggle))}),s&&(e[t.toggle.id]=t.toggle,t.toggle.style.display="none",this.conTag.appendChild(t.toggle),null!==t.click&&t.toggle.addEventListener("click",()=>{this[t.click](),changeVisibility(t.value),changeVisibility(t.toggle)}))}}})};a(n,this.ctrlBtns),this.target.appendChild(this.conTag),this.target.appendChild(this.progressBar())}playPause(){this.vTag.paused?this.vTag.play():this.vTag.pause()}stop(){this.close()}mute(){if(this.vTag.muted){let t=this.vTag.volume;this.vTag.volume=this.cache.volume,this.cache.volume=t}else this.cache.volume=this.vTag.volume,this.vTag.volume=0;this.vTag.muted=!this.vTag.muted}close(){this.conTag&&this.conTag.remove(),this.vTag&&this.vTag.remove()}inline(t){this.registerEvents(t);const e=t.VAST.Ad.InLine.Creatives,s=isObj(e)&&isArr(e.Creative)&&e.Creative[0];if(!s)return this.emit("error",new Error("Invalid xml! Creative was not found!"));switch(!0){case isObj(s.Linear):{let t=s.Linear.MediaFiles;const e=(t=isObj(t)&&isObj(t.MediaFile)&&t.MediaFile).__text;this.init(e)}}}getContent(t,e){const s=new XMLHttpRequest,i=t.indexOf("//")+2;s.open("OPTIONS",t.substring(0,i+t.substring(i).indexOf("/")),!0),s.send(),s.onreadystatechange=function(){if(4!==s.readyState)return;const i=new XMLHttpRequest;i.open("GET",t,!0),i.send(),i.onreadystatechange=function(){4===i.readyState&&e instanceof Function&&e({status:i.status,body:i.responseText,headers:i.getAllResponseHeaders()})}}}getImpression(t){this.getContent(t,e=>{if(200!==e.status)return setTimeout(()=>{this.close()},0),console.error("Error getContent from url: "+t+"\nResponse status: "+e.status);this.handleVast(e.body)})}handleVast(t){let e;if("{"===t[0]){let s;try{s=JSON.parse(t)}catch(t){}"object"==typeof s&&(e=(new X2JS).xml_str2json(s.adm))}if(!(e=e||(new X2JS).xml_str2json(t))||!isObj(e.VAST)||!isObj(e.VAST.Ad))return this.emit("error",new Error("Invalid XML was received!"));switch(!0){case isObj(e.VAST.Ad.InLine):return this.inline(e);case isObj(e.VAST.Ad.Wrapper):return this.wrapper(e);default:this.emit("error",new Error("Unhandled VAST.Ad was detected!"))}}wrapper(t){const e=t.VAST.Ad.Wrapper.VASTAdTagURI;if(!e)return this.emit("error",new Error("Invalid XML was received!"));this.registerEvents(t),this.getContent(e,function(t){if(200!==t.status)return console.error("Error getContent from url: "+e+"\nResponse status: "+t.status);this.handleVast(t.body)})}registerEvents(t){for(let e in t)if(t.hasOwnProperty(e)){if(isObj(t[e])){if(!isArr(t[e])){this.registerEvents(t[e]);continue}if("creative"===e.toLowerCase()){this.registerEvents(t[e]);continue}}switch(e.toLowerCase()){case"error":this.subscribe({event:e.toLowerCase(),url:t[e]});break;case"impression":this.subscribe({event:"impression",url:t[e],once:!0});break;case"clickthrough":this.on("ready",()=>{this.vTag.addEventListener("click",()=>{setTimeout(()=>{window.location.href=t[e]},10)})});break;case"clicktracking":this.on("ready",()=>{this.vTag.addEventListener("click",()=>{const s=document.createElement("img");s.setAttribute("src",t[e]),this.vTag.appendChild(s)})});break;case"tracking":{const s=["start","firstQuartile","midpoint","thirdQuartile","complete"];t[e].forEach(t=>{"string"==typeof t._event&&"string"==typeof t.__text&&this.subscribe({event:t._event,url:t.__text,once:-1!==s.indexOf(t._event)})});break}}}}subscribe(t){this[t.once?"once":"on"](t.event,()=>{const e=document.createElement("script");e.src=t.url,document.getElementsByTagName("body")[0].appendChild(e)})}}function isArr(t){return t instanceof Array}function isObj(t){return t instanceof Object}function changeVisibility(t){switch(t.style.display){case"none":t.style.display="";break;case"":t.style.display="none"}}function formatTime(t,e){if(e){let e=Math.trunc(t/3600);t%=3600;let s=Math.trunc(t/60),i=Math.trunc(t%60);return e.convert()+":"+s.convert()+":"+i.convert()}{let e=Math.trunc(t/60),s=Math.trunc(t%60);return e.convert()+":"+s.convert()}}Number.prototype.convert=function(){return(this+"").length<2?"0"+this:this};class Ctrl{constructor(t){const e=new VastPlayer(t.player);switch(t.run){case"timeout":setTimeout(()=>{e.getImpression(t.tag)},1e3*t.timeout);break;case"load":window.addEventListener("load",function(s){e.getImpression(t.tag)})}}}